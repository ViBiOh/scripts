#!/usr/bin/env bash

set -o nounset -o pipefail

main() {
  local BRANCH_NAME
  BRANCH_NAME=$(git symbolic-ref --short HEAD)

  if [[ -n "${BRANCH_NAME}" && "${BRANCH_NAME}" =~ (features|fixes)/([A-Z0-9]+[-_][0-9]+) ]]; then
    local PREFIX="${BASH_REMATCH[${#BASH_REMATCH[@]}-1]}"

    if [[ ! "$(cat "${1}")" =~ ^${PREFIX} ]] && [[ ! "$(cat "${1}")" =~ ^fixup! ]]; then
      sed -i.bak -e "1s/^/$PREFIX /" "${1}"
    fi
  fi

  exit 0
}

main "${@:-}"
