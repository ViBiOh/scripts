#!/usr/bin/env bash

set -o nounset -o pipefail -o errexit

script_dir() {
  if [[ -L ${BASH_SOURCE[0]} ]]; then
    dirname "$(readlink "${BASH_SOURCE[0]}")"
  else
    (
      cd "$(dirname "${BASH_SOURCE[0]}")" && pwd
    )
  fi
}

guess_component() {
  local COMPONENTS=()

  add_part() {
    local WORDS=()
    read -r -a WORDS <<<"$(printf "%s" "${1}" | sed 's|_| |g;s|-| |g;s|\.| |g')"

    COMPONENTS=("${COMPONENTS[@]}" "${WORDS[@]}")
  }

  for file in $(git diff --name-only --cached); do
    add_part "$(basename "${file%.*}")"

    local FILE_DIR
    FILE_DIR="$(dirname "${file}")"

    while [[ ${FILE_DIR} != "." ]]; do
      add_part "$(basename "${FILE_DIR}")"
      FILE_DIR="$(dirname "${FILE_DIR}")"
    done
  done

  printf "%s\n" "${COMPONENTS[@]}" | sort | uniq
}

main() {
  source "$(script_dir)/meta" && meta_init "var" "git" "http"
  var_color

  if ! git_is_inside; then
    var_error "not inside a git tree"
    return 1
  fi

  git_conventionnal_commits

  local SCOPE
  SCOPE="$(for i in "${!CONVENTIONAL_COMMIT_SCOPES[@]}"; do printf "%b%s%b %s\n" "${GREEN}" "${i}" "${RESET}" "${CONVENTIONAL_COMMIT_SCOPES[${i}]}"; done | fzf --height=20 --ansi --reverse | awk '{print $1}')"

  if [[ -z ${SCOPE} ]]; then
    return 1
  fi

  printf "SCOPE=%s\n" "${SCOPE}"

  local COMPONENT=""
  COMPONENT="$(cat <(guess_component) <(printf "None") | fzf --height=20 --ansi --reverse --prompt='Component>')"

  if [[ ${COMPONENT} == "None" ]]; then
    COMPONENT=""
  else
    COMPONENT="$(printf "(%s)" "${COMPONENT}")"
  fi
  printf "COMPONENT=%s\n" "${COMPONENT}"

  local MESSAGE=""
  var_read MESSAGE

  local BREAKING=""
  if var_confirm "Contains breaking changes"; then
    BREAKING="!"
  fi

  http_init_client
  if [[ -n ${GITHUB_TOKEN} ]]; then
    HTTP_CLIENT_ARGS+=("--header" "Authorization: token ${GITHUB_TOKEN}")
  fi

  local ISSUES=""
  http_request "https://api.github.com/repos/$(git_remote_repository)/issues?per_page=100"
  if [[ ${HTTP_STATUS} == "200" ]] && [[ $(jq -r '[.[] | select(.pull_request | not)] | length' "${HTTP_OUTPUT}") -ne 0 ]]; then
    ISSUES="$(cat <(jq -r '.[] | select(.pull_request | not) | "#" + (.number | tostring) + " " + .title' "${HTTP_OUTPUT}") <(printf "None") | fzf --height=20 --ansi --reverse --multi --prompt='Issues closed>' | awk '{print "Closes " $1}')"

    if [[ ${ISSUES} != "None" ]]; then
      ISSUES="\n\n${ISSUES}"
    fi
  fi
  rm "${HTTP_OUTPUT}"

  local SAFE_MESSAGE
  SAFE_MESSAGE="$(printf "%s" "${MESSAGE}" | sed "s|'|\\\'|g")"

  var_print_and_run "git commit --signoff --message $'$(printf "%s%s%s: %s%s" "${SCOPE}" "${COMPONENT}" "${BREAKING}" "${SAFE_MESSAGE}" "${ISSUES}")' ${*}"
}

main "${@}"
